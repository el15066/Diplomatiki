#!/bin/bash -vxe

[ "$1" ] || exit 1
+ '[' 11000 ']'

PERIOD="$1"
+ PERIOD=11000

# Prep
cd ~/el15066/erigon/
+ cd /home/route/el15066/erigon/
git status | grep -F '/inline_uv'
+ git status
+ grep -F /inline_uv
Your branch is up to date with 'origin/inline_uv'.

# Old code
find logz/code/ -name '*.runbin.hex' -delete || true
+ find logz/code/ -name '*.runbin.hex' -delete

# Globals
cat common/globals_codekje.go.template |
tee common/globals.go
+ cat common/globals_codekje.go.template
+ tee common/globals.go

package common

const BLOCKS = 10_000

const  STORAGE_TRACING = false
const       TX_DUMPING = false
const     CODE_DUMPING = true
const     JUMP_TRACING = true

const PREFETCH_BLOCKS           = false
const BLOCK_READAHEAD           = 0
const PREFETCH_ACCOUNTS         = false
const PREFETCH_CODE             = false
const USE_PREDICTORS            = false
const USE_STORAGE_PREFETCH_FILE = false

const PREFETCH_WORKERS_COUNT = 0

const TRACE_PREDICTED = false

const DEBUG_TX       = false
const DEBUG_TX_BLOCK = 0
const DEBUG_TX_INDEX = 0

const PREDICTOR_CACHE_SIZE      = 1024
const PREDICTOR_GAS_TO_GAZ_RATE = 64 // div 1024
const PREDICTOR_CALL_GAZ_BONUS  = 0
const PREDICTOR_RESERVE_GAZ_DIV = 2
const PREDICTOR_DB_PATH         = "dbdir/predictorDB_new"



// if CODE_DUMPING {
var CONTRACT_CODE       = map[Hash][]byte{}
var CONTRACT_CODE_COUNT = map[Hash]uint{}
var CONTRACT_CODE_ALIAS = map[Address]Hash{}
// }

var CALLID         = -1 // JUMP_TRACING
var CALLID_COUNTER =  0 // JUMP_TRACING

// if JUMP_TRACING {
var JUMP_COUNT         = map[Hash]uint{}
var JUMP_CALLS         = map[Hash]map[int]struct{}{}
var JUMP_DST_CALLCOUNT = map[Hash]map[uint32]map[uint32]map[int]uint{}
// }

# Make
make erigon
+ make erigon
Building Erigon
rm -f /home/route/el15066/erigon/build/bin/tg # Remove old binary to prevent confusion where users still use it because of the scripts
env GO111MODULE=on go build -trimpath -ldflags "-X github.com/ledgerwatch/erigon/params.GitCommit=8c9ccd401feec75029c402251ac083ce908ed03a -X github.com/ledgerwatch/erigon/params.GitBranch=inline_uv -X github.com/ledgerwatch/erigon/params.GitTag=v2021.08.05-370-g8c9ccd401" -o /home/route/el15066/erigon/build/bin/erigon ./cmd/erigon
Done building.
Run "/home/route/el15066/erigon/build/bin/erigon" to launch Erigon.

# Run
_T0=$(date +%s.%3N)
++ date +%s.%3N
+ _T0=1645981714.297
nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
+ nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
nice: cannot set niceness: Permission denied
[INFO] [02-27|17:08:34.348] Build info                               git_branch=inline_uv git_tag=v2021.08.05-370-g8c9ccd401 git_commit=8c9ccd401feec75029c402251ac083ce908ed03a
[INFO] [02-27|17:08:34.348] Starting Erigon on Ethereum mainnet... 
[INFO] [02-27|17:08:34.348] Maximum peer count                       ETH=100 total=100
[INFO] [02-27|17:08:34.348] Set global gas cap                       cap=50000000
[INFO] [02-27|17:08:34.388] Opening Database                         label=chaindata path=dbdir/erigon/data/chaindata
[INFO] [02-27|17:08:34.389] database closed                          label=chaindata
[INFO] [02-27|17:08:34.389] Opening Database                         label=chaindata path=/home/route/el15066/erigon/dbdir/erigon/data/chaindata
[INFO] [02-27|17:08:34.390] Initialised chain configuration          config="{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Engine: ethash}"
[INFO] [02-27|17:08:34.390] Disk storage enabled for ethash DAGs     dir=dbdir/erigon/ethash count=2
[INFO] [02-27|17:08:34.390] Initialising Ethereum protocol           network=1
[INFO] [02-27|17:08:34.390] Effective                                prune="--prune="
[INFO] [02-27|17:08:34.390] Starting private RPC server              on=127.0.0.1:9090
[INFO] [02-27|17:08:34.828] Stage Headers                   (Download headers) 
[INFO] [02-27|17:08:34.828] Stage Headers                   Done 
[INFO] [02-27|17:08:34.828] Stage BlockHashes               (Write block hashes) 
[INFO] [02-27|17:08:34.829] Stage BlockHashes               Done 
[INFO] [02-27|17:08:34.829] Stage CreateHeadersSnapshot     disabled. Enable by --snapshot.layout 
[INFO] [02-27|17:08:34.829] Stage Bodies                    (Download block bodies) 
[INFO] [02-27|17:08:34.829] Stage Bodies                    Done 
[INFO] [02-27|17:08:34.829] Stage CreateBodiesSnapshot      disabled. Enable by --snapshot.layout 
[INFO] [02-27|17:08:34.829] Stage Senders                   (Recover senders from tx signatures) 
[INFO] [02-27|17:08:34.829] Stage Senders                   Done 
[INFO] [02-27|17:08:34.829] Stage Execution                 (Execute blocks w/o hash checks) 
[INFO] [02-27|17:08:34.829] Globals                                  STORAGE_TRACING=false TX_DUMPING=false CODE_DUMPING=true JUMP_TRACING=true PREFETCH_BLOCKS=false BLOCK_READAHEAD=0 PREFETCH_ACCOUNTS=false PREFETCH_CODE=false USE_PREDICTORS=false USE_STORAGE_PREFETCH_FILE=false PREFETCH_WORKERS_COUNT=0 TRACE_PREDICTED=false DEBUG_TX=false DEBUG_TX_BLOCK=0 DEBUG_TX_INDEX=0 PREDICTOR_CACHE_SIZE=1024 PREDICTOR_GAS_TO_GAZ_RATE=64 PREDICTOR_RESERVE_GAZ_DIV=2 PREDICTOR_CALL_GAZ_BONUS=0 PREDICTOR_DB_PATH=dbdir/predictorDB_new
[INFO] [02-27|17:08:34.829] [7/18 Execution] Blocks execution        from=10999999 to=11009999
[EROR] [02-27|17:08:34.831] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0"
[INFO] [02-27|17:08:34.831] Started P2P networking                   version=65 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
[EROR] [02-27|17:08:34.832] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0"
[INFO] [02-27|17:08:34.832] Started P2P networking                   version=66 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         786662            962         756769
   4-   3       30429469            962       29273149
   9-   8            113            961            108
  10-   9             30            961             29
  11-  10             30            961             29
[INFO] [02-27|17:09:04.860] [7/18 Execution] Executed blocks         number=11000961 blk/s=32.034 tx/s=5476.363 Mgas/s=390.388 batch="28.81 MiB" alloc="1.46 GiB" sys="1.58 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         822775           1895        1559158
   4-   3       30848183           1895       58457307
   9-   8            115           1894            217
  10-   9             31           1894             58
  11-  10             30           1894             58
[INFO] [02-27|17:09:34.847] [7/18 Execution] Executed blocks         number=11001894 blk/s=31.113 tx/s=5848.053 Mgas/s=377.427 batch="49.88 MiB" alloc="2.19 GiB" sys="2.75 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         825421           2788        2301275
   4-   3       31455963           2788       87699226
   9-   8            115           2787            323
  10-   9             31           2787             86
  11-  10             30           2787             85
[INFO] [02-27|17:10:04.832] [7/18 Execution] Executed blocks         number=11002787 blk/s=29.782 tx/s=5273.466 Mgas/s=361.332 batch="68.58 MiB" alloc="2.29 GiB" sys="4.38 GiB"
[INFO] [02-27|17:10:34.391] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         825834           3672        3032465
   4-   3       31860595           3672      116992107
   9-   8            116           3671            426
  10-   9             31           3671            114
  11-  10             30           3671            112
[INFO] [02-27|17:10:34.857] [7/18 Execution] Executed blocks         number=11003671 blk/s=29.442 tx/s=5044.986 Mgas/s=359.239 batch="86.22 MiB" alloc="3.87 GiB" sys="5.30 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         825824           4516        3729425
   4-   3       32394155           4516      146292004
   9-   8            116           4515            525
  10-   9             31           4515            141
  11-  10             30           4515            138
[INFO] [02-27|17:11:04.855] [7/18 Execution] Executed blocks         number=11004515 blk/s=28.135 tx/s=4387.288 Mgas/s=342.846 batch="100.72 MiB" alloc="4.52 GiB" sys="6.54 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         813868           5340        4346059
   4-   3       32898339           5340      175677131
   9-   8            115           5339            617
  10-   9             31           5339            166
  11-  10             30           5339            163
[INFO] [02-27|17:11:34.858] [7/18 Execution] Executed blocks         number=11005339 blk/s=27.464 tx/s=3820.620 Mgas/s=332.341 batch="116.82 MiB" alloc="7.43 GiB" sys="7.84 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         817166           6166        5038650
   4-   3       33243663           6166      204980428
   9-   8            115           6165            713
  10-   9             31           6165            192
  11-  10             30           6165            188
[INFO] [02-27|17:12:04.855] [7/18 Execution] Executed blocks         number=11006165 blk/s=27.536 tx/s=4733.764 Mgas/s=332.006 batch="131.03 MiB" alloc="6.15 GiB" sys="9.34 GiB"
[INFO] [02-27|17:12:34.391] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         819256           7054        5779038
   4-   3       33204755           7054      234226346
   9-   8            115           7053            813
  10-   9             31           7053            220
  11-  10             30           7053            216
[INFO] [02-27|17:12:34.842] [7/18 Execution] Executed blocks         number=11007053 blk/s=29.612 tx/s=5175.382 Mgas/s=361.632 batch="149.06 MiB" alloc="7.49 GiB" sys="10.45 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         823131           7961        6552951
   4-   3       33094402           7961      263464536
   9-   8            115           7960            921
  10-   9             31           7960            248
  11-  10             30           7960            244
[INFO] [02-27|17:13:04.855] [7/18 Execution] Executed blocks         number=11007960 blk/s=30.220 tx/s=5565.872 Mgas/s=366.610 batch="166.08 MiB" alloc="8.53 GiB" sys="11.36 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         823155           8856        7289868
   4-   3       33052282           8856      292711016
   9-   8            115           8855           1025
  10-   9             31           8855            276
  11-  10             30           8855            271
[INFO] [02-27|17:13:34.840] [7/18 Execution] Executed blocks         number=11008855 blk/s=29.849 tx/s=5153.747 Mgas/s=359.163 batch="182.42 MiB" alloc="8.50 GiB" sys="12.67 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         824041           9689        7984138
   4-   3       33235326           9689      322017080
   9-   8            115           9688           1123
  10-   9             31           9688            302
  11-  10             30           9688            296
[INFO] [02-27|17:14:04.841] [7/18 Execution] Executed blocks         number=11009688 blk/s=27.765 tx/s=4755.360 Mgas/s=338.171 batch="195.78 MiB" alloc="9.04 GiB" sys="13.39 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         822495          10000        8224951
   4-   3       33329863          10000      333298633
   9-   8            115          10000           1158
  10-   9             31          10000            312
  11-  10             30          10000            306
  71-  70           3101        8521923       26430843
[INFO] [02-27|17:14:34.391] [p2p] GoodPeers                          eth66=0 eth65=0
[INFO] [02-27|17:15:14.879] Got interrupt, shutting down... 
[INFO] [02-27|17:15:15.001] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth66 updated=0 deleted=1
[INFO] [02-27|17:15:15.018] database closed                          label=sentry
[INFO] [02-27|17:15:15.019] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth65 updated=0 deleted=1
[INFO] [02-27|17:15:15.036] database closed                          label=sentry
[INFO] [02-27|17:15:15.530] database closed                          label=chaindata
_T1=$(date +%s.%3N)
++ date +%s.%3N
+ _T1=1645982116.109
_D=$(bc <<< "${_T1}-${_T0}")
++ bc
WALL_TIME 401.812
+ _D=401.812

# info
echo "WALL_TIME ${_D}"
+ echo 'WALL_TIME 401.812'


# LOGZ
cd logz/
+ cd logz/

# kje
python3 -u jump_stats.py
+ python3 -u jump_stats.py
Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading

# envon
cd ../symbolic/sandbox/envon_test/
+ cd ../symbolic/sandbox/envon_test/

# Old code
find code/ -name '*.evmlike' -delete || true
+ find code/ -name '*.evmlike' -delete

for f in ../../../logz/code/*.hex; do
  date +%s
  time PYTHONPATH=~/el15066/envon/ PYTHONHASHSEED=0 python3 -u -m envon -i $f -s -j ../../../logz/jump_edges.json -p SLOAD,SSTORE,CALL,CALLCODE,DELEGATECALL,STATICCALL,RETURN -o "code/$(basename $f | cut -d '.' -f 1).evmlike" -L info || true
  printf '\n\n\n'
done &>"log_${PERIOD}.txt"

ls code/ | wc -l
+ ls code/
+ wc -l
2191

# insert
cd ~/el15066/mdbx_insert/
+ cd /home/route/el15066/mdbx_insert/

python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ "auto_${PERIOD}"
+ python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ auto_11000
du -hL input.txt
+ du -hL input.txt
20M	input.txt
go run mdbx_clear.go
+ go run mdbx_clear.go
Clearing bucket 'p'
[INFO] [02-27|17:26:21.336] database closed                          where=mdbx_clear.go label=unknown
go run mdbx_insert.go
+ go run mdbx_insert.go
[INFO] [02-27|17:26:21.697] database closed                          where=mdbx_insert.go label=unknown


# restore globals
cd ../erigon/
+ cd ../erigon/
git checkout -- common/globals.go
+ git checkout -- common/globals.go
