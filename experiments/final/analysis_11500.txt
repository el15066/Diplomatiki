#!/bin/bash -vxe

[ "$1" ] || exit 1
+ '[' 11500 ']'

PERIOD="$1"
+ PERIOD=11500

# Prep
cd ~/el15066/erigon/
+ cd /home/route/el15066/erigon/
git status | grep -F '/inline_uv'
+ git status
+ grep -F /inline_uv
Your branch is up to date with 'origin/inline_uv'.

# Old code
find logz/code/ -name '*.runbin.hex' -delete || true
+ find logz/code/ -name '*.runbin.hex' -delete

# Globals
cat common/globals_codekje.go.template |
tee common/globals.go
+ cat common/globals_codekje.go.template
+ tee common/globals.go

package common

const BLOCKS = 10_000

const  STORAGE_TRACING = false
const       TX_DUMPING = false
const     CODE_DUMPING = true
const     JUMP_TRACING = true

const PREFETCH_BLOCKS           = false
const BLOCK_READAHEAD           = 0
const PREFETCH_ACCOUNTS         = false
const PREFETCH_CODE             = false
const USE_PREDICTORS            = false
const USE_STORAGE_PREFETCH_FILE = false

const PREFETCH_WORKERS_COUNT = 0

const TRACE_PREDICTED = false

const DEBUG_TX       = false
const DEBUG_TX_BLOCK = 0
const DEBUG_TX_INDEX = 0

const PREDICTOR_CACHE_SIZE      = 1024
const PREDICTOR_GAS_TO_GAZ_RATE = 64 // div 1024
const PREDICTOR_CALL_GAZ_BONUS  = 0
const PREDICTOR_RESERVE_GAZ_DIV = 2
const PREDICTOR_DB_PATH         = "dbdir/predictorDB_new"



// if CODE_DUMPING {
var CONTRACT_CODE       = map[Hash][]byte{}
var CONTRACT_CODE_COUNT = map[Hash]uint{}
var CONTRACT_CODE_ALIAS = map[Address]Hash{}
// }

var CALLID         = -1 // JUMP_TRACING
var CALLID_COUNTER =  0 // JUMP_TRACING

// if JUMP_TRACING {
var JUMP_COUNT         = map[Hash]uint{}
var JUMP_CALLS         = map[Hash]map[int]struct{}{}
var JUMP_DST_CALLCOUNT = map[Hash]map[uint32]map[uint32]map[int]uint{}
// }

# Make
make erigon
+ make erigon
Building Erigon
rm -f /home/route/el15066/erigon/build/bin/tg # Remove old binary to prevent confusion where users still use it because of the scripts
env GO111MODULE=on go build -trimpath -ldflags "-X github.com/ledgerwatch/erigon/params.GitCommit=8c9ccd401feec75029c402251ac083ce908ed03a -X github.com/ledgerwatch/erigon/params.GitBranch=inline_uv -X github.com/ledgerwatch/erigon/params.GitTag=v2021.08.05-370-g8c9ccd401" -o /home/route/el15066/erigon/build/bin/erigon ./cmd/erigon
Done building.
Run "/home/route/el15066/erigon/build/bin/erigon" to launch Erigon.

# Run
_T0=$(date +%s.%3N)
++ date +%s.%3N
+ _T0=1646004293.116
nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
+ nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
nice: cannot set niceness: Permission denied
[INFO] [02-27|23:24:53.167] Build info                               git_branch=inline_uv git_tag=v2021.08.05-370-g8c9ccd401 git_commit=8c9ccd401feec75029c402251ac083ce908ed03a
[INFO] [02-27|23:24:53.167] Starting Erigon on Ethereum mainnet... 
[INFO] [02-27|23:24:53.168] Maximum peer count                       ETH=100 total=100
[INFO] [02-27|23:24:53.168] Set global gas cap                       cap=50000000
[INFO] [02-27|23:24:53.207] Opening Database                         label=chaindata path=dbdir/erigon/data/chaindata
[INFO] [02-27|23:24:53.208] database closed                          label=chaindata
[INFO] [02-27|23:24:53.208] Opening Database                         label=chaindata path=/home/route/el15066/erigon/dbdir/erigon/data/chaindata
[INFO] [02-27|23:24:53.209] Initialised chain configuration          config="{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Engine: ethash}"
[INFO] [02-27|23:24:53.209] Disk storage enabled for ethash DAGs     dir=dbdir/erigon/ethash count=2
[INFO] [02-27|23:24:53.209] Initialising Ethereum protocol           network=1
[INFO] [02-27|23:24:53.209] Effective                                prune="--prune="
[INFO] [02-27|23:24:53.209] Starting private RPC server              on=127.0.0.1:9090
[INFO] [02-27|23:24:53.651] Stage Headers                   (Download headers) 
[INFO] [02-27|23:24:53.651] Stage Headers                   Done 
[INFO] [02-27|23:24:53.651] Stage BlockHashes               (Write block hashes) 
[INFO] [02-27|23:24:53.651] Stage BlockHashes               Done 
[INFO] [02-27|23:24:53.651] Stage CreateHeadersSnapshot     disabled. Enable by --snapshot.layout 
[INFO] [02-27|23:24:53.651] Stage Bodies                    (Download block bodies) 
[INFO] [02-27|23:24:53.651] Stage Bodies                    Done 
[INFO] [02-27|23:24:53.651] Stage CreateBodiesSnapshot      disabled. Enable by --snapshot.layout 
[INFO] [02-27|23:24:53.651] Stage Senders                   (Recover senders from tx signatures) 
[INFO] [02-27|23:24:53.651] Stage Senders                   Done 
[INFO] [02-27|23:24:53.651] Stage Execution                 (Execute blocks w/o hash checks) 
[INFO] [02-27|23:24:53.651] Globals                                  STORAGE_TRACING=false TX_DUMPING=false CODE_DUMPING=true JUMP_TRACING=true PREFETCH_BLOCKS=false BLOCK_READAHEAD=0 PREFETCH_ACCOUNTS=false PREFETCH_CODE=false USE_PREDICTORS=false USE_STORAGE_PREFETCH_FILE=false PREFETCH_WORKERS_COUNT=0 TRACE_PREDICTED=false DEBUG_TX=false DEBUG_TX_BLOCK=0 DEBUG_TX_INDEX=0 PREDICTOR_CACHE_SIZE=1024 PREDICTOR_GAS_TO_GAZ_RATE=64 PREDICTOR_RESERVE_GAZ_DIV=2 PREDICTOR_CALL_GAZ_BONUS=0 PREDICTOR_DB_PATH=dbdir/predictorDB_new
[INFO] [02-27|23:24:53.652] [7/18 Execution] Blocks execution        from=11499999 to=11509999
[EROR] [02-27|23:24:53.654] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0"
[INFO] [02-27|23:24:53.654] Started P2P networking                   version=66 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
[EROR] [02-27|23:24:53.655] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0"
[INFO] [02-27|23:24:53.655] Started P2P networking                   version=65 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         858991            927         796284
   4-   3       31533994            927       29232012
   9-   8            120            926            111
  10-   9             30            926             28
  11-  10             30            926             28
[INFO] [02-27|23:25:23.681] [7/18 Execution] Executed blocks         number=11500926 blk/s=30.870 tx/s=5644.496 Mgas/s=376.639 batch="25.64 MiB" alloc="1.54 GiB" sys="1.71 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         871585           1850        1612432
   4-   3       31576487           1850       58416501
   9-   8            121           1849            224
  10-   9             30           1849             56
  11-  10             30           1849             56
[INFO] [02-27|23:25:53.683] [7/18 Execution] Executed blocks         number=11501849 blk/s=30.765 tx/s=5849.599 Mgas/s=374.777 batch="47.00 MiB" alloc="1.82 GiB" sys="2.95 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         883530           2746        2426175
   4-   3       31899002           2746       87594661
   9-   8            124           2745            340
  10-   9             30           2745             83
  11-  10             30           2745             84
[INFO] [02-27|23:26:23.676] [7/18 Execution] Executed blocks         number=11502745 blk/s=29.874 tx/s=5788.425 Mgas/s=364.308 batch="66.32 MiB" alloc="3.57 GiB" sys="4.12 GiB"
[INFO] [02-27|23:26:53.210] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         881324           3677        3240628
   4-   3       31756170           3677      116767440
   9-   8            123           3676            453
  10-   9             30           3676            112
  11-  10             31           3676            114
[INFO] [02-27|23:26:53.664] [7/18 Execution] Executed blocks         number=11503676 blk/s=31.045 tx/s=5635.759 Mgas/s=378.706 batch="86.38 MiB" alloc="5.08 GiB" sys="5.43 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         886948           4551        4036503
   4-   3       32072653           4551      145962646
   9-   8            123           4550            560
  10-   9             30           4550            139
  11-  10             31           4550            141
[INFO] [02-27|23:27:23.656] [7/18 Execution] Executed blocks         number=11504550 blk/s=29.141 tx/s=5425.422 Mgas/s=356.869 batch="103.64 MiB" alloc="6.30 GiB" sys="6.67 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         875887           5413        4741177
   4-   3       32377030           5413      175256863
   9-   8            123           5412            670
  10-   9             30           5412            165
  11-  10             31           5412            168
[INFO] [02-27|23:27:53.656] [7/18 Execution] Executed blocks         number=11505412 blk/s=28.733 tx/s=4465.077 Mgas/s=350.966 batch="120.94 MiB" alloc="6.02 GiB" sys="7.84 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         865425           6219        5382080
   4-   3       32904274           6219      204631682
   9-   8            124           6218            771
  10-   9             30           6218            190
  11-  10             31           6218            192
[INFO] [02-27|23:28:23.673] [7/18 Execution] Executed blocks         number=11506218 blk/s=26.852 tx/s=4033.486 Mgas/s=328.885 batch="136.17 MiB" alloc="8.38 GiB" sys="8.95 GiB"
[INFO] [02-27|23:28:53.210] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         869148           7055        6131843
   4-   3       33151502           7055      233883853
   9-   8            124           7054            879
  10-   9             30           7054            215
  11-  10             30           7054            218
[INFO] [02-27|23:28:53.676] [7/18 Execution] Executed blocks         number=11507054 blk/s=27.864 tx/s=4779.393 Mgas/s=340.187 batch="152.14 MiB" alloc="10.06 GiB" sys="10.58 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         875624           7924        6938450
   4-   3       33199135           7924      263069950
   9-   8            124           7923            986
  10-   9             30           7923            245
  11-  10             31           7923            245
[INFO] [02-27|23:29:23.669] [7/18 Execution] Executed blocks         number=11507923 blk/s=28.973 tx/s=5550.957 Mgas/s=354.264 batch="168.12 MiB" alloc="10.96 GiB" sys="11.56 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         893071           8827        7883144
   4-   3       33093819           8827      292119141
   9-   8            124           8826           1098
  10-   9             30           8826            272
  11-  10             30           8826            273
[INFO] [02-27|23:29:53.664] [7/18 Execution] Executed blocks         number=11508826 blk/s=30.105 tx/s=6401.438 Mgas/s=367.349 batch="185.69 MiB" alloc="11.69 GiB" sys="12.60 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         901014           9720        8757864
   4-   3       33050946           9720      321255195
   9-   8            124           9719           1212
  10-   9             30           9719            300
  11-  10             30           9719            300
[INFO] [02-27|23:30:23.676] [7/18 Execution] Executed blocks         number=11509719 blk/s=29.755 tx/s=6305.240 Mgas/s=362.396 batch="202.37 MiB" alloc="12.07 GiB" sys="13.33 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         902599          10000        9025998
   4-   3       33057325          10000      330573258
   9-   8            124          10000           1245
  10-   9             30          10000            308
  11-  10             30          10000            309
  71-  70           2832        8539224       24187496
[INFO] [02-27|23:30:53.209] [p2p] GoodPeers                          eth66=0 eth65=0
[INFO] [02-27|23:31:30.682] Got interrupt, shutting down... 
[INFO] [02-27|23:31:30.836] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth66 updated=0 deleted=1
[INFO] [02-27|23:31:30.844] database closed                          label=sentry
[INFO] [02-27|23:31:30.845] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth65 updated=0 deleted=1
[INFO] [02-27|23:31:30.845] database closed                          label=sentry
[INFO] [02-27|23:31:31.465] database closed                          label=chaindata
_T1=$(date +%s.%3N)
++ date +%s.%3N
+ _T1=1646004692.067
_D=$(bc <<< "${_T1}-${_T0}")
++ bc
+ _D=398.951

# info
echo "WALL_TIME ${_D}"
WALL_TIME 398.951
+ echo 'WALL_TIME 398.951'


# LOGZ
cd logz/
+ cd logz/

# kje
python3 -u jump_stats.py
+ python3 -u jump_stats.py
Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading

# envon
cd ../symbolic/sandbox/envon_test/
+ cd ../symbolic/sandbox/envon_test/

# Old code
find code/ -name '*.evmlike' -delete || true
+ find code/ -name '*.evmlike' -delete

for f in ../../../logz/code/*.hex; do
  date +%s
  time PYTHONPATH=~/el15066/envon/ PYTHONHASHSEED=0 python3 -u -m envon -i $f -s -j ../../../logz/jump_edges.json -p SLOAD,SSTORE,CALL,CALLCODE,DELEGATECALL,STATICCALL,RETURN -o "code/$(basename $f | cut -d '.' -f 1).evmlike" -L info || true
  printf '\n\n\n'
done &>"log_${PERIOD}.txt"

ls code/ | wc -l
+ ls code/
+ wc -l
2444

# insert
cd ~/el15066/mdbx_insert/
+ cd /home/route/el15066/mdbx_insert/

python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ "auto_${PERIOD}"
+ python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ auto_11500
du -hL input.txt
+ du -hL input.txt
27M	input.txt
go run mdbx_clear.go
+ go run mdbx_clear.go
Clearing bucket 'p'
[INFO] [02-27|23:53:55.620] database closed                          where=mdbx_clear.go label=unknown
go run mdbx_insert.go
+ go run mdbx_insert.go
[INFO] [02-27|23:53:56.000] database closed                          where=mdbx_insert.go label=unknown


# restore globals
cd ../erigon/
+ cd ../erigon/
git checkout -- common/globals.go
+ git checkout -- common/globals.go
