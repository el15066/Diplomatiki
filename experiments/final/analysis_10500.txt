#!/bin/bash -vxe

[ "$1" ] || exit 1
+ '[' 10500 ']'

PERIOD="$1"
+ PERIOD=10500

# Prep
cd ~/el15066/erigon/
+ cd /home/route/el15066/erigon/
git status | grep -F '/inline_uv'
+ git status
+ grep -F /inline_uv
Your branch is up to date with 'origin/inline_uv'.

# Old code
find logz/code/ -name '*.runbin.hex' -delete || true
+ find logz/code/ -name '*.runbin.hex' -delete

# Globals
cat common/globals_codekje.go.template |
tee common/globals.go
+ cat common/globals_codekje.go.template
+ tee common/globals.go

package common

const BLOCKS = 10_000

const  STORAGE_TRACING = false
const       TX_DUMPING = false
const     CODE_DUMPING = true
const     JUMP_TRACING = true

const PREFETCH_BLOCKS           = false
const BLOCK_READAHEAD           = 0
const PREFETCH_ACCOUNTS         = false
const PREFETCH_CODE             = false
const USE_PREDICTORS            = false
const USE_STORAGE_PREFETCH_FILE = false

const PREFETCH_WORKERS_COUNT = 0

const TRACE_PREDICTED = false

const DEBUG_TX       = false
const DEBUG_TX_BLOCK = 0
const DEBUG_TX_INDEX = 0

const PREDICTOR_CACHE_SIZE      = 1024
const PREDICTOR_GAS_TO_GAZ_RATE = 64 // div 1024
const PREDICTOR_CALL_GAZ_BONUS  = 0
const PREDICTOR_RESERVE_GAZ_DIV = 2
const PREDICTOR_DB_PATH         = "dbdir/predictorDB_new"



// if CODE_DUMPING {
var CONTRACT_CODE       = map[Hash][]byte{}
var CONTRACT_CODE_COUNT = map[Hash]uint{}
var CONTRACT_CODE_ALIAS = map[Address]Hash{}
// }

var CALLID         = -1 // JUMP_TRACING
var CALLID_COUNTER =  0 // JUMP_TRACING

// if JUMP_TRACING {
var JUMP_COUNT         = map[Hash]uint{}
var JUMP_CALLS         = map[Hash]map[int]struct{}{}
var JUMP_DST_CALLCOUNT = map[Hash]map[uint32]map[uint32]map[int]uint{}
// }

# Make
make erigon
+ make erigon
Building Erigon
rm -f /home/route/el15066/erigon/build/bin/tg # Remove old binary to prevent confusion where users still use it because of the scripts
env GO111MODULE=on go build -trimpath -ldflags "-X github.com/ledgerwatch/erigon/params.GitCommit=8c9ccd401feec75029c402251ac083ce908ed03a -X github.com/ledgerwatch/erigon/params.GitBranch=inline_uv -X github.com/ledgerwatch/erigon/params.GitTag=v2021.08.05-370-g8c9ccd401" -o /home/route/el15066/erigon/build/bin/erigon ./cmd/erigon
Done building.
Run "/home/route/el15066/erigon/build/bin/erigon" to launch Erigon.

# Run
_T0=$(date +%s.%3N)
++ date +%s.%3N
+ _T0=1645959856.737
nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
+ nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
nice: cannot set niceness: Permission denied
[INFO] [02-27|11:04:16.787] Build info                               git_branch=inline_uv git_tag=v2021.08.05-370-g8c9ccd401 git_commit=8c9ccd401feec75029c402251ac083ce908ed03a
[INFO] [02-27|11:04:16.787] Starting Erigon on Ethereum mainnet... 
[INFO] [02-27|11:04:16.788] Maximum peer count                       ETH=100 total=100
[INFO] [02-27|11:04:16.788] Set global gas cap                       cap=50000000
[INFO] [02-27|11:04:16.827] Opening Database                         label=chaindata path=dbdir/erigon/data/chaindata
[INFO] [02-27|11:04:16.828] database closed                          label=chaindata
[INFO] [02-27|11:04:16.828] Opening Database                         label=chaindata path=/home/route/el15066/erigon/dbdir/erigon/data/chaindata
[INFO] [02-27|11:04:16.829] Initialised chain configuration          config="{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Engine: ethash}"
[INFO] [02-27|11:04:16.829] Disk storage enabled for ethash DAGs     dir=dbdir/erigon/ethash count=2
[INFO] [02-27|11:04:16.829] Initialising Ethereum protocol           network=1
[INFO] [02-27|11:04:16.829] Effective                                prune="--prune="
[INFO] [02-27|11:04:16.829] Starting private RPC server              on=127.0.0.1:9090
[INFO] [02-27|11:04:17.280] Stage Headers                   (Download headers) 
[INFO] [02-27|11:04:17.280] Stage Headers                   Done 
[INFO] [02-27|11:04:17.280] Stage BlockHashes               (Write block hashes) 
[INFO] [02-27|11:04:17.280] Stage BlockHashes               Done 
[INFO] [02-27|11:04:17.280] Stage CreateHeadersSnapshot     disabled. Enable by --snapshot.layout 
[INFO] [02-27|11:04:17.280] Stage Bodies                    (Download block bodies) 
[INFO] [02-27|11:04:17.280] Stage Bodies                    Done 
[INFO] [02-27|11:04:17.280] Stage CreateBodiesSnapshot      disabled. Enable by --snapshot.layout 
[INFO] [02-27|11:04:17.280] Stage Senders                   (Recover senders from tx signatures) 
[INFO] [02-27|11:04:17.280] Stage Senders                   Done 
[INFO] [02-27|11:04:17.280] Stage Execution                 (Execute blocks w/o hash checks) 
[INFO] [02-27|11:04:17.280] Globals                                  STORAGE_TRACING=false TX_DUMPING=false CODE_DUMPING=true JUMP_TRACING=true PREFETCH_BLOCKS=false BLOCK_READAHEAD=0 PREFETCH_ACCOUNTS=false PREFETCH_CODE=false USE_PREDICTORS=false USE_STORAGE_PREFETCH_FILE=false PREFETCH_WORKERS_COUNT=0 TRACE_PREDICTED=false DEBUG_TX=false DEBUG_TX_BLOCK=0 DEBUG_TX_INDEX=0 PREDICTOR_CACHE_SIZE=1024 PREDICTOR_GAS_TO_GAZ_RATE=64 PREDICTOR_RESERVE_GAZ_DIV=2 PREDICTOR_CALL_GAZ_BONUS=0 PREDICTOR_DB_PATH=dbdir/predictorDB_new
[INFO] [02-27|11:04:17.280] [7/18 Execution] Blocks execution        from=10499999 to=10509999
[EROR] [02-27|11:04:17.286] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0"
[INFO] [02-27|11:04:17.286] Started P2P networking                   version=66 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
[EROR] [02-27|11:04:17.304] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0"
[INFO] [02-27|11:04:17.304] Started P2P networking                   version=65 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         901288           1117        1006738
   4-   3       25981457           1117       29021288
   9-   8            117           1116            131
  10-   9             31           1116             34
  11-  10             30           1116             34
[INFO] [02-27|11:04:47.309] [7/18 Execution] Executed blocks         number=10501116 blk/s=37.197 tx/s=7048.082 Mgas/s=429.443 batch="30.88 MiB" alloc="1.13 GiB" sys="1.45 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         890864           2239        1994645
   4-   3       25909607           2239       58011610
   9-   8            120           2238            268
  10-   9             31           2238             69
  11-  10             31           2238             69
[INFO] [02-27|11:05:17.289] [7/18 Execution] Executed blocks         number=10502238 blk/s=37.426 tx/s=7355.992 Mgas/s=427.315 batch="57.17 MiB" alloc="2.46 GiB" sys="2.69 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         876663           3331        2920167
   4-   3       26148623           3331       87101064
   9-   8            120           3330            402
  10-   9             31           3330            103
  11-  10             31           3330            103
[INFO] [02-27|11:05:47.305] [7/18 Execution] Executed blocks         number=10503330 blk/s=36.380 tx/s=6854.957 Mgas/s=408.674 batch="81.13 MiB" alloc="2.84 GiB" sys="3.73 GiB"
[INFO] [02-27|11:06:16.830] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         869528           4373        3802446
   4-   3       26572849           4373      116203070
   9-   8            120           4372            527
  10-   9             31           4372            136
  11-  10             31           4372            136
[INFO] [02-27|11:06:17.290] [7/18 Execution] Executed blocks         number=10504372 blk/s=34.750 tx/s=5851.827 Mgas/s=391.312 batch="104.33 MiB" alloc="3.37 GiB" sys="4.84 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         854683           5397        4612727
   4-   3       26942107           5397      145406552
   9-   8            121           5396            653
  10-   9             31           5396            168
  11-  10             31           5396            168
[INFO] [02-27|11:06:47.305] [7/18 Execution] Executed blocks         number=10505396 blk/s=34.116 tx/s=5141.568 Mgas/s=392.121 batch="128.08 MiB" alloc="4.39 GiB" sys="5.88 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         849833           6436        5469525
   4-   3       27117852           6436      174530495
   9-   8            121           6435            784
  10-   9             31           6435            200
  11-  10             31           6435            200
[INFO] [02-27|11:07:17.287] [7/18 Execution] Executed blocks         number=10506435 blk/s=34.654 tx/s=5563.542 Mgas/s=401.520 batch="153.59 MiB" alloc="5.12 GiB" sys="7.31 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         854308           7504        6410734
   4-   3       27132210           7504      203600108
   9-   8            123           7503            923
  10-   9             31           7503            233
  11-  10             31           7503            234
[INFO] [02-27|11:07:47.299] [7/18 Execution] Executed blocks         number=10507503 blk/s=35.586 tx/s=6969.724 Mgas/s=410.380 batch="174.87 MiB" alloc="7.36 GiB" sys="8.30 GiB"
[INFO] [02-27|11:08:16.831] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         856965           8589        7360477
   4-   3       27085719           8589      232639242
   9-   8            122           8588           1055
  10-   9             31           8588            267
  11-  10             31           8588            268
[INFO] [02-27|11:08:17.290] [7/18 Execution] Executed blocks         number=10508588 blk/s=36.179 tx/s=7136.908 Mgas/s=410.944 batch="196.47 MiB" alloc="5.73 GiB" sys="9.61 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         855187           9631        8236311
   4-   3       27179716           9631      261767848
   9-   8            123           9630           1187
  10-   9             31           9630            300
  11-  10             31           9630            301
[INFO] [02-27|11:08:47.295] [7/18 Execution] Executed blocks         number=10509630 blk/s=34.727 tx/s=6318.710 Mgas/s=397.877 batch="217.69 MiB" alloc="6.90 GiB" sys="10.58 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         853775          10000        8537754
   4-   3       27276484          10000      272764841
   9-   8            123          10000           1233
  10-   9             31          10000            311
  11-  10             31          10000            312
  71-  70           2330        8798733       20505538
[INFO] [02-27|11:09:42.998] Got interrupt, shutting down... 
[INFO] [02-27|11:09:43.114] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth66 updated=0 deleted=1
[INFO] [02-27|11:09:43.128] database closed                          label=sentry
[INFO] [02-27|11:09:43.145] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth65 updated=0 deleted=1
[INFO] [02-27|11:09:43.145] database closed                          label=sentry
[INFO] [02-27|11:09:43.789] database closed                          label=chaindata
_T1=$(date +%s.%3N)
++ date +%s.%3N
+ _T1=1645960184.212
_D=$(bc <<< "${_T1}-${_T0}")
++ bc
WALL_TIME 327.475
+ _D=327.475

# info
echo "WALL_TIME ${_D}"
+ echo 'WALL_TIME 327.475'


# LOGZ
cd logz/
+ cd logz/

# kje
python3 -u jump_stats.py
+ python3 -u jump_stats.py
Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading

# envon
cd ../symbolic/sandbox/envon_test/
+ cd ../symbolic/sandbox/envon_test/

# Old code
find code/ -name '*.evmlike' -delete || true
+ find code/ -name '*.evmlike' -delete

for f in ../../../logz/code/*.hex; do
  date +%s
  time PYTHONPATH=~/el15066/envon/ PYTHONHASHSEED=0 python3 -u -m envon -i $f -s -j ../../../logz/jump_edges.json -p SLOAD,SSTORE,CALL,CALLCODE,DELEGATECALL,STATICCALL,RETURN -o "code/$(basename $f | cut -d '.' -f 1).evmlike" -L info || true
  printf '\n\n\n'
done &>"log_${PERIOD}.txt"

ls code/ | wc -l
+ ls code/
+ wc -l
1502

# insert
cd ~/el15066/mdbx_insert/
+ cd /home/route/el15066/mdbx_insert/

python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ "auto_${PERIOD}"
+ python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ auto_10500
du -hL input.txt
+ du -hL input.txt
15M	input.txt
go run mdbx_clear.go
+ go run mdbx_clear.go
Clearing bucket 'p'
[INFO] [02-27|11:19:55.007] database closed                          where=mdbx_clear.go label=unknown
go run mdbx_insert.go
+ go run mdbx_insert.go
[INFO] [02-27|11:19:55.372] database closed                          where=mdbx_insert.go label=unknown


# restore globals
cd ../erigon/
+ cd ../erigon/
git checkout -- common/globals.go
+ git checkout -- common/globals.go
