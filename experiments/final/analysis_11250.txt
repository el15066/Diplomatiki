#!/bin/bash -vxe

[ "$1" ] || exit 1
+ '[' 11250 ']'

PERIOD="$1"
+ PERIOD=11250

# Prep
cd ~/el15066/erigon/
+ cd /home/route/el15066/erigon/
git status | grep -F '/inline_uv'
+ git status
+ grep -F /inline_uv
Your branch is up to date with 'origin/inline_uv'.

# Old code
find logz/code/ -name '*.runbin.hex' -delete || true
+ find logz/code/ -name '*.runbin.hex' -delete

# Globals
cat common/globals_codekje.go.template |
tee common/globals.go
+ cat common/globals_codekje.go.template
+ tee common/globals.go

package common

const BLOCKS = 10_000

const  STORAGE_TRACING = false
const       TX_DUMPING = false
const     CODE_DUMPING = true
const     JUMP_TRACING = true

const PREFETCH_BLOCKS           = false
const BLOCK_READAHEAD           = 0
const PREFETCH_ACCOUNTS         = false
const PREFETCH_CODE             = false
const USE_PREDICTORS            = false
const USE_STORAGE_PREFETCH_FILE = false

const PREFETCH_WORKERS_COUNT = 0

const TRACE_PREDICTED = false

const DEBUG_TX       = false
const DEBUG_TX_BLOCK = 0
const DEBUG_TX_INDEX = 0

const PREDICTOR_CACHE_SIZE      = 1024
const PREDICTOR_GAS_TO_GAZ_RATE = 64 // div 1024
const PREDICTOR_CALL_GAZ_BONUS  = 0
const PREDICTOR_RESERVE_GAZ_DIV = 2
const PREDICTOR_DB_PATH         = "dbdir/predictorDB_new"



// if CODE_DUMPING {
var CONTRACT_CODE       = map[Hash][]byte{}
var CONTRACT_CODE_COUNT = map[Hash]uint{}
var CONTRACT_CODE_ALIAS = map[Address]Hash{}
// }

var CALLID         = -1 // JUMP_TRACING
var CALLID_COUNTER =  0 // JUMP_TRACING

// if JUMP_TRACING {
var JUMP_COUNT         = map[Hash]uint{}
var JUMP_CALLS         = map[Hash]map[int]struct{}{}
var JUMP_DST_CALLCOUNT = map[Hash]map[uint32]map[uint32]map[int]uint{}
// }

# Make
make erigon
+ make erigon
Building Erigon
rm -f /home/route/el15066/erigon/build/bin/tg # Remove old binary to prevent confusion where users still use it because of the scripts
env GO111MODULE=on go build -trimpath -ldflags "-X github.com/ledgerwatch/erigon/params.GitCommit=8c9ccd401feec75029c402251ac083ce908ed03a -X github.com/ledgerwatch/erigon/params.GitBranch=inline_uv -X github.com/ledgerwatch/erigon/params.GitTag=v2021.08.05-370-g8c9ccd401" -o /home/route/el15066/erigon/build/bin/erigon ./cmd/erigon
Done building.
Run "/home/route/el15066/erigon/build/bin/erigon" to launch Erigon.

# Run
_T0=$(date +%s.%3N)
++ date +%s.%3N
+ _T0=1645992906.832
nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
+ nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
nice: cannot set niceness: Permission denied
[INFO] [02-27|20:15:06.883] Build info                               git_branch=inline_uv git_tag=v2021.08.05-370-g8c9ccd401 git_commit=8c9ccd401feec75029c402251ac083ce908ed03a
[INFO] [02-27|20:15:06.883] Starting Erigon on Ethereum mainnet... 
[INFO] [02-27|20:15:06.884] Maximum peer count                       ETH=100 total=100
[INFO] [02-27|20:15:06.884] Set global gas cap                       cap=50000000
[INFO] [02-27|20:15:06.923] Opening Database                         label=chaindata path=dbdir/erigon/data/chaindata
[INFO] [02-27|20:15:06.924] database closed                          label=chaindata
[INFO] [02-27|20:15:06.924] Opening Database                         label=chaindata path=/home/route/el15066/erigon/dbdir/erigon/data/chaindata
[INFO] [02-27|20:15:06.925] Initialised chain configuration          config="{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Engine: ethash}"
[INFO] [02-27|20:15:06.925] Disk storage enabled for ethash DAGs     dir=dbdir/erigon/ethash count=2
[INFO] [02-27|20:15:06.925] Initialising Ethereum protocol           network=1
[INFO] [02-27|20:15:06.925] Effective                                prune="--prune="
[INFO] [02-27|20:15:06.925] Starting private RPC server              on=127.0.0.1:9090
[INFO] [02-27|20:15:07.365] Stage Headers                   (Download headers) 
[INFO] [02-27|20:15:07.365] Stage Headers                   Done 
[INFO] [02-27|20:15:07.365] Stage BlockHashes               (Write block hashes) 
[INFO] [02-27|20:15:07.365] Stage BlockHashes               Done 
[INFO] [02-27|20:15:07.365] Stage CreateHeadersSnapshot     disabled. Enable by --snapshot.layout 
[INFO] [02-27|20:15:07.365] Stage Bodies                    (Download block bodies) 
[INFO] [02-27|20:15:07.365] Stage Bodies                    Done 
[INFO] [02-27|20:15:07.365] Stage CreateBodiesSnapshot      disabled. Enable by --snapshot.layout 
[INFO] [02-27|20:15:07.365] Stage Senders                   (Recover senders from tx signatures) 
[INFO] [02-27|20:15:07.365] Stage Senders                   Done 
[INFO] [02-27|20:15:07.365] Stage Execution                 (Execute blocks w/o hash checks) 
[INFO] [02-27|20:15:07.365] Globals                                  STORAGE_TRACING=false TX_DUMPING=false CODE_DUMPING=true JUMP_TRACING=true PREFETCH_BLOCKS=false BLOCK_READAHEAD=0 PREFETCH_ACCOUNTS=false PREFETCH_CODE=false USE_PREDICTORS=false USE_STORAGE_PREFETCH_FILE=false PREFETCH_WORKERS_COUNT=0 TRACE_PREDICTED=false DEBUG_TX=false DEBUG_TX_BLOCK=0 DEBUG_TX_INDEX=0 PREDICTOR_CACHE_SIZE=1024 PREDICTOR_GAS_TO_GAZ_RATE=64 PREDICTOR_RESERVE_GAZ_DIV=2 PREDICTOR_CALL_GAZ_BONUS=0 PREDICTOR_DB_PATH=dbdir/predictorDB_new
[INFO] [02-27|20:15:07.365] [7/18 Execution] Blocks execution        from=11249999 to=11259999
[EROR] [02-27|20:15:07.367] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0"
[INFO] [02-27|20:15:07.367] Started P2P networking                   version=66 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
[EROR] [02-27|20:15:07.368] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0"
[INFO] [02-27|20:15:07.368] Started P2P networking                   version=65 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         843778            866         730712
   4-   3       33836669            866       29302556
   9-   8            128            865            111
  10-   9             30            865             26
  11-  10             31            865             26
[INFO] [02-27|20:15:37.400] [7/18 Execution] Executed blocks         number=11250865 blk/s=28.834 tx/s=5273.967 Mgas/s=354.615 batch="26.55 MiB" alloc="1.36 GiB" sys="1.51 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         809404           1717        1389747
   4-   3       34138153           1717       58615209
   9-   8            131           1716            225
  10-   9             30           1716             52
  11-  10             31           1716             53
[INFO] [02-27|20:16:07.372] [7/18 Execution] Executed blocks         number=11251716 blk/s=28.393 tx/s=4512.244 Mgas/s=345.087 batch="48.64 MiB" alloc="1.92 GiB" sys="2.69 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         792419           2558        2027009
   4-   3       34400845           2558       87997363
   9-   8            128           2557            327
  10-   9             30           2557             78
  11-  10             31           2557             79
[INFO] [02-27|20:16:37.393] [7/18 Execution] Executed blocks         number=11252557 blk/s=28.014 tx/s=4345.516 Mgas/s=340.439 batch="68.90 MiB" alloc="3.44 GiB" sys="3.73 GiB"
[INFO] [02-27|20:17:06.926] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         791314           3466        2742696
   4-   3       33837825           3466      117281901
   9-   8            128           3465            445
  10-   9             30           3465            105
  11-  10             31           3465            107
[INFO] [02-27|20:17:07.394] [7/18 Execution] Executed blocks         number=11253465 blk/s=30.265 tx/s=5118.452 Mgas/s=365.031 batch="92.77 MiB" alloc="3.22 GiB" sys="5.30 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         776490           4401        3417335
   4-   3       33313760           4401      146613860
   9-   8            127           4400            559
  10-   9             30           4400            134
  11-  10             31           4400            137
[INFO] [02-27|20:17:37.402] [7/18 Execution] Executed blocks         number=11254400 blk/s=31.159 tx/s=4920.777 Mgas/s=379.543 batch="118.81 MiB" alloc="3.76 GiB" sys="6.41 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         783512           5301        4153399
   4-   3       33172779           5301      175848902
   9-   8            126           5300            671
  10-   9             30           5300            162
  11-  10             31           5300            165
[INFO] [02-27|20:18:07.374] [7/18 Execution] Executed blocks         number=11255300 blk/s=30.028 tx/s=5659.587 Mgas/s=367.236 batch="139.28 MiB" alloc="6.18 GiB" sys="7.26 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         785683           6120        4808382
   4-   3       33527198           6120      205186455
   9-   8            125           6119            769
  10-   9             30           6119            187
  11-  10             31           6119            190
[INFO] [02-27|20:18:37.367] [7/18 Execution] Executed blocks         number=11256119 blk/s=27.306 tx/s=4634.741 Mgas/s=332.700 batch="156.51 MiB" alloc="5.67 GiB" sys="8.36 GiB"
[INFO] [02-27|20:19:06.926] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         788649           6977        5502408
   4-   3       33609925           6977      234496450
   9-   8            126           6976            880
  10-   9             30           6976            213
  11-  10             31           6976            217
[INFO] [02-27|20:19:07.372] [7/18 Execution] Executed blocks         number=11256976 blk/s=28.562 tx/s=5109.041 Mgas/s=346.780 batch="173.75 MiB" alloc="6.64 GiB" sys="10.13 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         788781           7782        6138294
   4-   3       33908839           7782      263878585
   9-   8            126           7781            986
  10-   9             30           7781            238
  11-  10             31           7781            242
[INFO] [02-27|20:19:37.391] [7/18 Execution] Executed blocks         number=11257781 blk/s=26.816 tx/s=4295.517 Mgas/s=330.664 batch="190.14 MiB" alloc="7.46 GiB" sys="10.78 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         778030           8679        6752527
   4-   3       33790604           8679      293268655
   9-   8            127           8678           1102
  10-   9             30           8678            265
  11-  10             31           8678            269
[INFO] [02-27|20:20:07.396] [7/18 Execution] Executed blocks         number=11258678 blk/s=29.895 tx/s=3883.042 Mgas/s=366.287 batch="213.78 MiB" alloc="7.63 GiB" sys="12.02 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         769926           9575        7372049
   4-   3       33696415           9575      322643176
   9-   8            126           9574           1215
  10-   9             30           9574            293
  11-  10             31           9574            297
[INFO] [02-27|20:20:37.392] [7/18 Execution] Executed blocks         number=11259574 blk/s=29.872 tx/s=4263.401 Mgas/s=363.553 batch="235.43 MiB" alloc="7.13 GiB" sys="13.32 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         769471          10000        7694712
   4-   3       33657653          10000      336576537
   9-   8            126          10000           1265
  10-   9             30          10000            306
  11-  10             31          10000            310
  71-  70           5112        9055390       46299267
[INFO] [02-27|20:21:06.925] [p2p] GoodPeers                          eth66=0 eth65=0
[INFO] [02-27|20:21:45.021] Got interrupt, shutting down... 
[INFO] [02-27|20:21:45.149] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth66 updated=0 deleted=1
[INFO] [02-27|20:21:45.168] database closed                          label=sentry
[INFO] [02-27|20:21:45.169] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth65 updated=0 deleted=1
[INFO] [02-27|20:21:45.174] database closed                          label=sentry
[INFO] [02-27|20:21:45.772] database closed                          label=chaindata
_T1=$(date +%s.%3N)
++ date +%s.%3N
+ _T1=1645993306.344
_D=$(bc <<< "${_T1}-${_T0}")
++ bc
WALL_TIME 399.512
+ _D=399.512

# info
echo "WALL_TIME ${_D}"
+ echo 'WALL_TIME 399.512'


# LOGZ
cd logz/
+ cd logz/

# kje
python3 -u jump_stats.py
+ python3 -u jump_stats.py
Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading

# envon
cd ../symbolic/sandbox/envon_test/
+ cd ../symbolic/sandbox/envon_test/

# Old code
find code/ -name '*.evmlike' -delete || true
+ find code/ -name '*.evmlike' -delete

for f in ../../../logz/code/*.hex; do
  date +%s
  time PYTHONPATH=~/el15066/envon/ PYTHONHASHSEED=0 python3 -u -m envon -i $f -s -j ../../../logz/jump_edges.json -p SLOAD,SSTORE,CALL,CALLCODE,DELEGATECALL,STATICCALL,RETURN -o "code/$(basename $f | cut -d '.' -f 1).evmlike" -L info || true
  printf '\n\n\n'
done &>"log_${PERIOD}.txt"

ls code/ | wc -l
+ ls code/
+ wc -l
2395

# insert
cd ~/el15066/mdbx_insert/
+ cd /home/route/el15066/mdbx_insert/

python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ "auto_${PERIOD}"
+ python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ auto_11250
du -hL input.txt
+ du -hL input.txt
23M	input.txt
go run mdbx_clear.go
+ go run mdbx_clear.go
Clearing bucket 'p'
[INFO] [02-27|20:33:50.628] database closed                          where=mdbx_clear.go label=unknown
go run mdbx_insert.go
+ go run mdbx_insert.go
[INFO] [02-27|20:33:50.995] database closed                          where=mdbx_insert.go label=unknown


# restore globals
cd ../erigon/
+ cd ../erigon/
git checkout -- common/globals.go
+ git checkout -- common/globals.go
