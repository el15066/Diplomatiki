#!/bin/bash -vxe

[ "$1" ] || exit 1
+ '[' 11750 ']'

PERIOD="$1"
+ PERIOD=11750

# Prep
cd ~/el15066/erigon/
+ cd /home/route/el15066/erigon/
git status | grep -F '/inline_uv'
+ git status
+ grep -F /inline_uv
Your branch is up to date with 'origin/inline_uv'.

# Old code
find logz/code/ -name '*.runbin.hex' -delete || true
+ find logz/code/ -name '*.runbin.hex' -delete

# Globals
cat common/globals_codekje.go.template |
tee common/globals.go
+ cat common/globals_codekje.go.template
+ tee common/globals.go

package common

const BLOCKS = 10_000

const  STORAGE_TRACING = false
const       TX_DUMPING = false
const     CODE_DUMPING = true
const     JUMP_TRACING = true

const PREFETCH_BLOCKS           = false
const BLOCK_READAHEAD           = 0
const PREFETCH_ACCOUNTS         = false
const PREFETCH_CODE             = false
const USE_PREDICTORS            = false
const USE_STORAGE_PREFETCH_FILE = false

const PREFETCH_WORKERS_COUNT = 0

const TRACE_PREDICTED = false

const DEBUG_TX       = false
const DEBUG_TX_BLOCK = 0
const DEBUG_TX_INDEX = 0

const PREDICTOR_CACHE_SIZE      = 1024
const PREDICTOR_GAS_TO_GAZ_RATE = 64 // div 1024
const PREDICTOR_CALL_GAZ_BONUS  = 0
const PREDICTOR_RESERVE_GAZ_DIV = 2
const PREDICTOR_DB_PATH         = "dbdir/predictorDB_new"



// if CODE_DUMPING {
var CONTRACT_CODE       = map[Hash][]byte{}
var CONTRACT_CODE_COUNT = map[Hash]uint{}
var CONTRACT_CODE_ALIAS = map[Address]Hash{}
// }

var CALLID         = -1 // JUMP_TRACING
var CALLID_COUNTER =  0 // JUMP_TRACING

// if JUMP_TRACING {
var JUMP_COUNT         = map[Hash]uint{}
var JUMP_CALLS         = map[Hash]map[int]struct{}{}
var JUMP_DST_CALLCOUNT = map[Hash]map[uint32]map[uint32]map[int]uint{}
// }

# Make
make erigon
+ make erigon
Building Erigon
rm -f /home/route/el15066/erigon/build/bin/tg # Remove old binary to prevent confusion where users still use it because of the scripts
env GO111MODULE=on go build -trimpath -ldflags "-X github.com/ledgerwatch/erigon/params.GitCommit=8c9ccd401feec75029c402251ac083ce908ed03a -X github.com/ledgerwatch/erigon/params.GitBranch=inline_uv -X github.com/ledgerwatch/erigon/params.GitTag=v2021.08.05-370-g8c9ccd401" -o /home/route/el15066/erigon/build/bin/erigon ./cmd/erigon
Done building.
Run "/home/route/el15066/erigon/build/bin/erigon" to launch Erigon.

# Run
_T0=$(date +%s.%3N)
++ date +%s.%3N
+ _T0=1646016480.950
nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
+ nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
nice: cannot set niceness: Permission denied
[INFO] [02-28|02:48:01.001] Build info                               git_branch=inline_uv git_tag=v2021.08.05-370-g8c9ccd401 git_commit=8c9ccd401feec75029c402251ac083ce908ed03a
[INFO] [02-28|02:48:01.001] Starting Erigon on Ethereum mainnet... 
[INFO] [02-28|02:48:01.002] Maximum peer count                       ETH=100 total=100
[INFO] [02-28|02:48:01.002] Set global gas cap                       cap=50000000
[INFO] [02-28|02:48:01.041] Opening Database                         label=chaindata path=dbdir/erigon/data/chaindata
[INFO] [02-28|02:48:01.043] database closed                          label=chaindata
[INFO] [02-28|02:48:01.043] Opening Database                         label=chaindata path=/home/route/el15066/erigon/dbdir/erigon/data/chaindata
[INFO] [02-28|02:48:01.044] Initialised chain configuration          config="{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Engine: ethash}"
[INFO] [02-28|02:48:01.044] Disk storage enabled for ethash DAGs     dir=dbdir/erigon/ethash count=2
[INFO] [02-28|02:48:01.044] Initialising Ethereum protocol           network=1
[INFO] [02-28|02:48:01.044] Effective                                prune="--prune="
[INFO] [02-28|02:48:01.044] Starting private RPC server              on=127.0.0.1:9090
[INFO] [02-28|02:48:01.641] Stage Headers                   (Download headers) 
[INFO] [02-28|02:48:01.641] Stage Headers                   Done 
[INFO] [02-28|02:48:01.641] Stage BlockHashes               (Write block hashes) 
[INFO] [02-28|02:48:01.641] Stage BlockHashes               Done 
[INFO] [02-28|02:48:01.641] Stage CreateHeadersSnapshot     disabled. Enable by --snapshot.layout 
[INFO] [02-28|02:48:01.641] Stage Bodies                    (Download block bodies) 
[INFO] [02-28|02:48:01.641] Stage Bodies                    Done 
[INFO] [02-28|02:48:01.641] Stage CreateBodiesSnapshot      disabled. Enable by --snapshot.layout 
[INFO] [02-28|02:48:01.641] Stage Senders                   (Recover senders from tx signatures) 
[INFO] [02-28|02:48:01.641] Stage Senders                   Done 
[INFO] [02-28|02:48:01.641] Stage Execution                 (Execute blocks w/o hash checks) 
[INFO] [02-28|02:48:01.641] Globals                                  STORAGE_TRACING=false TX_DUMPING=false CODE_DUMPING=true JUMP_TRACING=true PREFETCH_BLOCKS=false BLOCK_READAHEAD=0 PREFETCH_ACCOUNTS=false PREFETCH_CODE=false USE_PREDICTORS=false USE_STORAGE_PREFETCH_FILE=false PREFETCH_WORKERS_COUNT=0 TRACE_PREDICTED=false DEBUG_TX=false DEBUG_TX_BLOCK=0 DEBUG_TX_INDEX=0 PREDICTOR_CACHE_SIZE=1024 PREDICTOR_GAS_TO_GAZ_RATE=64 PREDICTOR_RESERVE_GAZ_DIV=2 PREDICTOR_CALL_GAZ_BONUS=0 PREDICTOR_DB_PATH=dbdir/predictorDB_new
[INFO] [02-28|02:48:01.641] [7/18 Execution] Blocks execution        from=11749999 to=11759999
[EROR] [02-28|02:48:01.643] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0"
[INFO] [02-28|02:48:01.643] Started P2P networking                   version=66 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
[EROR] [02-28|02:48:01.644] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0"
[INFO] [02-28|02:48:01.644] Started P2P networking                   version=65 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         991935            875         867943
   4-   3       33321151            875       29156007
   9-   8            117            874            102
  10-   9             31            874             27
  11-  10             30            874             26
[INFO] [02-28|02:48:31.666] [7/18 Execution] Executed blocks         number=11750874 blk/s=29.143 tx/s=6101.694 Mgas/s=355.613 batch="24.84 MiB" alloc="1.45 GiB" sys="1.58 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         981391           1710        1678180
   4-   3       34123295           1710       58350835
   9-   8            116           1709            199
  10-   9             31           1709             53
  11-  10             30           1709             52
[INFO] [02-28|02:49:01.672] [7/18 Execution] Executed blocks         number=11751709 blk/s=27.828 tx/s=5677.465 Mgas/s=341.608 batch="45.09 MiB" alloc="2.07 GiB" sys="2.62 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         963990           2554        2462032
   4-   3       34290182           2554       87577125
   9-   8            116           2553            296
  10-   9             31           2553             79
  11-  10             30           2553             78
[INFO] [02-28|02:49:31.683] [7/18 Execution] Executed blocks         number=11752553 blk/s=28.123 tx/s=5365.188 Mgas/s=340.883 batch="64.25 MiB" alloc="3.82 GiB" sys="4.06 GiB"
[INFO] [02-28|02:50:01.045] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         961017           3353        3222290
   4-   3       34827938           3353      116778077
   9-   8            116           3352            391
  10-   9             31           3352            104
  11-  10             30           3352            103
[INFO] [02-28|02:50:01.645] [7/18 Execution] Executed blocks         number=11753352 blk/s=26.667 tx/s=4923.117 Mgas/s=325.525 batch="81.47 MiB" alloc="3.72 GiB" sys="5.23 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         950755           4150        3945633
   4-   3       35197412           4150      146069263
   9-   8            117           4149            486
  10-   9             31           4149            128
  11-  10             30           4149            128
[INFO] [02-28|02:50:31.661] [7/18 Execution] Executed blocks         number=11754149 blk/s=26.553 tx/s=4512.014 Mgas/s=325.305 batch="98.89 MiB" alloc="4.40 GiB" sys="6.34 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         945059           4988        4713955
   4-   3       35150095           4988      175328675
   9-   8            116           4987            582
  10-   9             31           4987            155
  11-  10             30           4987            154
[INFO] [02-28|02:51:01.689] [7/18 Execution] Executed blocks         number=11754987 blk/s=27.907 tx/s=5228.260 Mgas/s=339.647 batch="117.30 MiB" alloc="6.69 GiB" sys="7.06 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         930378           5783        5380378
   4-   3       35385044           5783      204631713
   9-   8            116           5782            674
  10-   9             31           5782            179
  11-  10             30           5782            178
[INFO] [02-28|02:51:31.660] [7/18 Execution] Executed blocks         number=11755782 blk/s=26.526 tx/s=4657.664 Mgas/s=325.585 batch="136.39 MiB" alloc="5.71 GiB" sys="8.43 GiB"
[INFO] [02-28|02:52:01.045] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         935680           6613        6187654
   4-   3       35356815           6613      233814619
   9-   8            117           6612            773
  10-   9             31           6612            205
  11-  10             30           6612            204
[INFO] [02-28|02:52:01.651] [7/18 Execution] Executed blocks         number=11756612 blk/s=27.675 tx/s=5866.599 Mgas/s=338.899 batch="153.89 MiB" alloc="7.28 GiB" sys="9.73 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         932098           7443        6937612
   4-   3       35346093           7443      263080970
   9-   8            117           7442            870
  10-   9             31           7442            231
  11-  10             30           7442            229
[INFO] [02-28|02:52:31.668] [7/18 Execution] Executed blocks         number=11757442 blk/s=27.651 tx/s=5062.243 Mgas/s=339.155 batch="171.93 MiB" alloc="8.22 GiB" sys="10.45 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         935734           8223        7694542
   4-   3       35550019           8223      292327809
   9-   8            116           8222            959
  10-   9             31           8222            255
  11-  10             31           8222            255
[INFO] [02-28|02:53:01.673] [7/18 Execution] Executed blocks         number=11758222 blk/s=25.996 tx/s=5190.611 Mgas/s=317.300 batch="185.81 MiB" alloc="8.72 GiB" sys="11.63 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         937748           9021        8459430
   4-   3       35646242           9021      321564749
   9-   8            116           9020           1050
  10-   9             31           9020            280
  11-  10             30           9020            279
[INFO] [02-28|02:53:31.676] [7/18 Execution] Executed blocks         number=11759020 blk/s=26.598 tx/s=5299.838 Mgas/s=323.372 batch="200.74 MiB" alloc="8.44 GiB" sys="12.80 GiB"
[INFO] [02-28|02:54:01.044] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         936170           9795        9169787
   4-   3       35817942           9795      350836743
   9-   8            116           9794           1140
  10-   9             31           9794            304
  11-  10             30           9794            303
[INFO] [02-28|02:54:01.659] [7/18 Execution] Executed blocks         number=11759794 blk/s=25.814 tx/s=4803.441 Mgas/s=313.601 batch="214.53 MiB" alloc="8.28 GiB" sys="14.04 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         935622          10000        9356226
   4-   3       35870421          10000      358704218
   9-   8            116          10000           1162
  10-   9             31          10000            310
  11-  10             30          10000            309
  71-  70           2843        8702504       24748350
[INFO] [02-28|02:55:07.009] Got interrupt, shutting down... 
[INFO] [02-28|02:55:07.126] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth66 updated=0 deleted=1
[INFO] [02-28|02:55:07.148] database closed                          label=sentry
[INFO] [02-28|02:55:07.149] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth65 updated=0 deleted=1
[INFO] [02-28|02:55:07.165] database closed                          label=sentry
[INFO] [02-28|02:55:07.990] database closed                          label=chaindata
_T1=$(date +%s.%3N)
++ date +%s.%3N
+ _T1=1646016908.633
_D=$(bc <<< "${_T1}-${_T0}")
++ bc
WALL_TIME 427.683
+ _D=427.683

# info
echo "WALL_TIME ${_D}"
+ echo 'WALL_TIME 427.683'


# LOGZ
cd logz/
+ cd logz/

# kje
python3 -u jump_stats.py
+ python3 -u jump_stats.py
Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading

# envon
cd ../symbolic/sandbox/envon_test/
+ cd ../symbolic/sandbox/envon_test/

# Old code
find code/ -name '*.evmlike' -delete || true
+ find code/ -name '*.evmlike' -delete

for f in ../../../logz/code/*.hex; do
  date +%s
  time PYTHONPATH=~/el15066/envon/ PYTHONHASHSEED=0 python3 -u -m envon -i $f -s -j ../../../logz/jump_edges.json -p SLOAD,SSTORE,CALL,CALLCODE,DELEGATECALL,STATICCALL,RETURN -o "code/$(basename $f | cut -d '.' -f 1).evmlike" -L info || true
  printf '\n\n\n'
done &>"log_${PERIOD}.txt"

ls code/ | wc -l
+ ls code/
+ wc -l
2315

# insert
cd ~/el15066/mdbx_insert/
+ cd /home/route/el15066/mdbx_insert/

python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ "auto_${PERIOD}"
+ python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ auto_11750
du -hL input.txt
+ du -hL input.txt
25M	input.txt
go run mdbx_clear.go
+ go run mdbx_clear.go
Clearing bucket 'p'
[INFO] [02-28|03:10:59.623] database closed                          where=mdbx_clear.go label=unknown
go run mdbx_insert.go
+ go run mdbx_insert.go
[INFO] [02-28|03:10:59.997] database closed                          where=mdbx_insert.go label=unknown


# restore globals
cd ../erigon/
+ cd ../erigon/
git checkout -- common/globals.go
+ git checkout -- common/globals.go
