#!/bin/bash -vxe

[ "$1" ] || exit 1
+ '[' 10750 ']'

PERIOD="$1"
+ PERIOD=10750

# Prep
cd ~/el15066/erigon/
+ cd /home/route/el15066/erigon/
git status | grep -F '/inline_uv'
+ git status
+ grep -F /inline_uv
Your branch is up to date with 'origin/inline_uv'.

# Old code
find logz/code/ -name '*.runbin.hex' -delete || true
+ find logz/code/ -name '*.runbin.hex' -delete

# Globals
cat common/globals_codekje.go.template |
tee common/globals.go
+ cat common/globals_codekje.go.template
+ tee common/globals.go

package common

const BLOCKS = 10_000

const  STORAGE_TRACING = false
const       TX_DUMPING = false
const     CODE_DUMPING = true
const     JUMP_TRACING = true

const PREFETCH_BLOCKS           = false
const BLOCK_READAHEAD           = 0
const PREFETCH_ACCOUNTS         = false
const PREFETCH_CODE             = false
const USE_PREDICTORS            = false
const USE_STORAGE_PREFETCH_FILE = false

const PREFETCH_WORKERS_COUNT = 0

const TRACE_PREDICTED = false

const DEBUG_TX       = false
const DEBUG_TX_BLOCK = 0
const DEBUG_TX_INDEX = 0

const PREDICTOR_CACHE_SIZE      = 1024
const PREDICTOR_GAS_TO_GAZ_RATE = 64 // div 1024
const PREDICTOR_CALL_GAZ_BONUS  = 0
const PREDICTOR_RESERVE_GAZ_DIV = 2
const PREDICTOR_DB_PATH         = "dbdir/predictorDB_new"



// if CODE_DUMPING {
var CONTRACT_CODE       = map[Hash][]byte{}
var CONTRACT_CODE_COUNT = map[Hash]uint{}
var CONTRACT_CODE_ALIAS = map[Address]Hash{}
// }

var CALLID         = -1 // JUMP_TRACING
var CALLID_COUNTER =  0 // JUMP_TRACING

// if JUMP_TRACING {
var JUMP_COUNT         = map[Hash]uint{}
var JUMP_CALLS         = map[Hash]map[int]struct{}{}
var JUMP_DST_CALLCOUNT = map[Hash]map[uint32]map[uint32]map[int]uint{}
// }

# Make
make erigon
+ make erigon
Building Erigon
rm -f /home/route/el15066/erigon/build/bin/tg # Remove old binary to prevent confusion where users still use it because of the scripts
env GO111MODULE=on go build -trimpath -ldflags "-X github.com/ledgerwatch/erigon/params.GitCommit=8c9ccd401feec75029c402251ac083ce908ed03a -X github.com/ledgerwatch/erigon/params.GitBranch=inline_uv -X github.com/ledgerwatch/erigon/params.GitTag=v2021.08.05-370-g8c9ccd401" -o /home/route/el15066/erigon/build/bin/erigon ./cmd/erigon
Done building.
Run "/home/route/el15066/erigon/build/bin/erigon" to launch Erigon.

# Run
_T0=$(date +%s.%3N)
++ date +%s.%3N
+ _T0=1645970487.975
nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
+ nice --10 taskset -c 3-5,16-17 ./build/bin/erigon --datadir dbdir/erigon/data/ --ethash.dagdir dbdir/erigon/ethash/ --nodiscover --port 30123
nice: cannot set niceness: Permission denied
[INFO] [02-27|14:01:28.026] Build info                               git_branch=inline_uv git_tag=v2021.08.05-370-g8c9ccd401 git_commit=8c9ccd401feec75029c402251ac083ce908ed03a
[INFO] [02-27|14:01:28.026] Starting Erigon on Ethereum mainnet... 
[INFO] [02-27|14:01:28.027] Maximum peer count                       ETH=100 total=100
[INFO] [02-27|14:01:28.027] Set global gas cap                       cap=50000000
[INFO] [02-27|14:01:28.066] Opening Database                         label=chaindata path=dbdir/erigon/data/chaindata
[INFO] [02-27|14:01:28.067] database closed                          label=chaindata
[INFO] [02-27|14:01:28.067] Opening Database                         label=chaindata path=/home/route/el15066/erigon/dbdir/erigon/data/chaindata
[INFO] [02-27|14:01:28.068] Initialised chain configuration          config="{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Engine: ethash}"
[INFO] [02-27|14:01:28.068] Disk storage enabled for ethash DAGs     dir=dbdir/erigon/ethash count=2
[INFO] [02-27|14:01:28.068] Initialising Ethereum protocol           network=1
[INFO] [02-27|14:01:28.068] Effective                                prune="--prune="
[INFO] [02-27|14:01:28.068] Starting private RPC server              on=127.0.0.1:9090
[INFO] [02-27|14:01:28.523] Stage Headers                   (Download headers) 
[INFO] [02-27|14:01:28.523] Stage Headers                   Done 
[INFO] [02-27|14:01:28.523] Stage BlockHashes               (Write block hashes) 
[INFO] [02-27|14:01:28.524] Stage BlockHashes               Done 
[INFO] [02-27|14:01:28.524] Stage CreateHeadersSnapshot     disabled. Enable by --snapshot.layout 
[INFO] [02-27|14:01:28.524] Stage Bodies                    (Download block bodies) 
[INFO] [02-27|14:01:28.524] Stage Bodies                    Done 
[INFO] [02-27|14:01:28.524] Stage CreateBodiesSnapshot      disabled. Enable by --snapshot.layout 
[INFO] [02-27|14:01:28.524] Stage Senders                   (Recover senders from tx signatures) 
[INFO] [02-27|14:01:28.524] Stage Senders                   Done 
[INFO] [02-27|14:01:28.524] Stage Execution                 (Execute blocks w/o hash checks) 
[INFO] [02-27|14:01:28.524] Globals                                  STORAGE_TRACING=false TX_DUMPING=false CODE_DUMPING=true JUMP_TRACING=true PREFETCH_BLOCKS=false BLOCK_READAHEAD=0 PREFETCH_ACCOUNTS=false PREFETCH_CODE=false USE_PREDICTORS=false USE_STORAGE_PREFETCH_FILE=false PREFETCH_WORKERS_COUNT=0 TRACE_PREDICTED=false DEBUG_TX=false DEBUG_TX_BLOCK=0 DEBUG_TX_INDEX=0 PREDICTOR_CACHE_SIZE=1024 PREDICTOR_GAS_TO_GAZ_RATE=64 PREDICTOR_RESERVE_GAZ_DIV=2 PREDICTOR_CALL_GAZ_BONUS=0 PREDICTOR_DB_PATH=dbdir/predictorDB_new
[INFO] [02-27|14:01:28.524] [7/18 Execution] Blocks execution        from=10749999 to=10759999
[EROR] [02-27|14:01:28.527] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0"
[INFO] [02-27|14:01:28.527] Started P2P networking                   version=65 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30304?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
[EROR] [02-27|14:01:28.527] Write enode to file failed               self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0"
[INFO] [02-27|14:01:28.527] Started P2P networking                   version=66 self="enode://cf90152aad373d1608af933850566e82f8ad78089ffe361b9f94664a081ba07596b6dbf4b38dfdde9f4a7470414f76c803b66ad56e4920db7bb09fa445d3c458@127.0.0.1:30123?discport=0" name=erigon/v2021.08.5-alpha-8c9ccd40/linux-amd64/go1.16.14
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         821123            918         753790
   4-   3       31885749            918       29271117
   9-   8            111            917            102
  10-   9             30            917             28
  11-  10             31            917             28
[INFO] [02-27|14:01:58.550] [7/18 Execution] Executed blocks         number=10750917 blk/s=30.574 tx/s=5208.587 Mgas/s=366.163 batch="21.30 MiB" alloc="1.46 GiB" sys="1.58 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         802039           1857        1489387
   4-   3       31511224           1857       58516343
   9-   8            111           1856            206
  10-   9             30           1856             56
  11-  10             31           1856             57
[INFO] [02-27|14:02:28.532] [7/18 Execution] Executed blocks         number=10751856 blk/s=31.319 tx/s=4776.054 Mgas/s=377.706 batch="42.78 MiB" alloc="1.86 GiB" sys="2.95 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         800505           2812        2251021
   4-   3       31205078           2812       87748681
   9-   8            112           2811            315
  10-   9             30           2811             86
  11-  10             31           2811             87
[INFO] [02-27|14:02:58.527] [7/18 Execution] Executed blocks         number=10752811 blk/s=31.839 tx/s=4999.388 Mgas/s=385.943 batch="63.72 MiB" alloc="3.50 GiB" sys="3.99 GiB"
[INFO] [02-27|14:03:28.069] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         803757           3779        3037398
   4-   3       30957769           3779      116989412
   9-   8            113           3778            427
  10-   9             30           3778            115
  11-  10             31           3778            117
[INFO] [02-27|14:03:28.555] [7/18 Execution] Executed blocks         number=10753778 blk/s=32.203 tx/s=5606.726 Mgas/s=385.229 batch="84.28 MiB" alloc="3.14 GiB" sys="5.43 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         811158           4747        3850568
   4-   3       30790104           4747      146160625
   9-   8            112           4746            536
  10-   9             30           4746            145
  11-  10             31           4746            148
[INFO] [02-27|14:03:58.540] [7/18 Execution] Executed blocks         number=10754746 blk/s=32.282 tx/s=6187.425 Mgas/s=385.978 batch="103.73 MiB" alloc="6.51 GiB" sys="6.86 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         807483           5743        4637379
   4-   3       30537090           5743      175374510
   9-   8            113           5742            650
  10-   9             30           5742            176
  11-  10             31           5742            179
[INFO] [02-27|14:04:28.542] [7/18 Execution] Executed blocks         number=10755742 blk/s=33.198 tx/s=5860.737 Mgas/s=401.072 batch="126.36 MiB" alloc="6.12 GiB" sys="7.58 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         814635           6591        5369262
   4-   3       31046276           6591      204626009
   9-   8            113           6590            747
  10-   9             30           6590            202
  11-  10             31           6590            205
[INFO] [02-27|14:04:58.527] [7/18 Execution] Executed blocks         number=10756590 blk/s=28.281 tx/s=5079.909 Mgas/s=343.910 batch="140.94 MiB" alloc="8.51 GiB" sys="8.95 GiB"
[INFO] [02-27|14:05:28.069] [p2p] GoodPeers                          eth66=0 eth65=0
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         823230           7390        6083673
   4-   3       31653182           7390      233917021
   9-   8            113           7389            839
  10-   9             30           7389            226
  11-  10             31           7389            230
[INFO] [02-27|14:05:28.533] [7/18 Execution] Executed blocks         number=10757389 blk/s=26.628 tx/s=4707.767 Mgas/s=323.042 batch="153.38 MiB" alloc="6.71 GiB" sys="9.92 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         822878           8208        6754185
   4-   3       32071195           8208      263240373
   9-   8            113           8207            931
  10-   9             30           8207            251
  11-  10             31           8207            256
[INFO] [02-27|14:05:58.528] [7/18 Execution] Executed blocks         number=10758207 blk/s=27.271 tx/s=4396.926 Mgas/s=330.128 batch="166.93 MiB" alloc="6.58 GiB" sys="11.94 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         818851           9065        7422885
   4-   3       32277596           9065      292596412
   9-   8            113           9064           1031
  10-   9             30           9064            278
  11-  10             31           9064            283
[INFO] [02-27|14:06:28.554] [7/18 Execution] Executed blocks         number=10759064 blk/s=28.542 tx/s=4426.731 Mgas/s=344.773 batch="180.02 MiB" alloc="11.67 GiB" sys="12.27 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         819575           9930        8138384
   4-   3       32414426           9930      321875253
   9-   8            113           9929           1130
  10-   9             30           9929            304
  11-  10             31           9929            311
[INFO] [02-27|14:06:58.549] [7/18 Execution] Executed blocks         number=10759929 blk/s=28.838 tx/s=4876.656 Mgas/s=346.288 batch="195.32 MiB" alloc="11.81 GiB" sys="13.31 GiB"
__TO-FROM ___AVERAGE_ns_ _______COUNT__ _____TOTAL_us_
   1-   0         820311          10000        8203119
   4-   3       32442956          10000      324429561
   9-   8            113          10000           1138
  10-   9             30          10000            306
  11-  10             31          10000            313
  71-  70           2867        8742482       25067379
[INFO] [02-27|14:07:28.069] [p2p] GoodPeers                          eth66=0 eth65=0
[INFO] [02-27|14:08:00.277] Got interrupt, shutting down... 
[INFO] [02-27|14:08:00.413] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth66 updated=0 deleted=1
[INFO] [02-27|14:08:00.423] database closed                          label=sentry
[INFO] [02-27|14:08:00.424] Successfully update p2p node database    path=/home/route/el15066/erigon/dbdir/erigon/data/nodes/eth65 updated=0 deleted=1
[INFO] [02-27|14:08:00.424] database closed                          label=sentry
[INFO] [02-27|14:08:00.943] database closed                          label=chaindata
_T1=$(date +%s.%3N)
++ date +%s.%3N
+ _T1=1645970881.495
_D=$(bc <<< "${_T1}-${_T0}")
++ bc
WALL_TIME 393.520
+ _D=393.520

# info
echo "WALL_TIME ${_D}"
+ echo 'WALL_TIME 393.520'


# LOGZ
cd logz/
+ cd logz/

# kje
python3 -u jump_stats.py
+ python3 -u jump_stats.py
Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading
Read 100 contracts
Verifying sums
Verified
Transforming
Transformed

Reading

# envon
cd ../symbolic/sandbox/envon_test/
+ cd ../symbolic/sandbox/envon_test/

# Old code
find code/ -name '*.evmlike' -delete || true
+ find code/ -name '*.evmlike' -delete

for f in ../../../logz/code/*.hex; do
  date +%s
  time PYTHONPATH=~/el15066/envon/ PYTHONHASHSEED=0 python3 -u -m envon -i $f -s -j ../../../logz/jump_edges.json -p SLOAD,SSTORE,CALL,CALLCODE,DELEGATECALL,STATICCALL,RETURN -o "code/$(basename $f | cut -d '.' -f 1).evmlike" -L info || true
  printf '\n\n\n'
done &>"log_${PERIOD}.txt"

ls code/ | wc -l
+ ls code/
+ wc -l
1531

# insert
cd ~/el15066/mdbx_insert/
+ cd /home/route/el15066/mdbx_insert/

python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ "auto_${PERIOD}"
+ python3 ../envon/tools/encode_predictors.py input.txt ../erigon/symbolic/sandbox/envon_test/code/ auto_10750
du -hL input.txt
+ du -hL input.txt
17M	input.txt
go run mdbx_clear.go
+ go run mdbx_clear.go
Clearing bucket 'p'
[INFO] [02-27|14:20:19.027] database closed                          where=mdbx_clear.go label=unknown
go run mdbx_insert.go
+ go run mdbx_insert.go
[INFO] [02-27|14:20:19.375] database closed                          where=mdbx_insert.go label=unknown


# restore globals
cd ../erigon/
+ cd ../erigon/
git checkout -- common/globals.go
+ git checkout -- common/globals.go
