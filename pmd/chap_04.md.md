
# Υλοποίηση συστήματος προανάκτησης

Στο κεφάλαιο αυτό περιγράφεται συνοπτικά η αρχιτεκτονική του συστήματος, καθώς και οι στόχοι και περιορισμοί που τέθηκαν για την υλοποίησή του.
Η περιγραφή περιέχει τις βασικές πληροφορίες που χρειάζονται στο κεφάλαιο των αποτελσμάτων, ώστε το επόμενο κεφάλαιο με την εκτενή περιγραφή να μπορεί να προσπεραστεί.

## Σκοπός και περιορισμοί

Όπως περιγράφηκαι στο προηγούμενο κεφάλαιο, η διαδικασία του συγχρονισμού στον client *erigon* διεκπεραιώνεται σε διακριτά στάδια.
Μιας και το στάδιο εκτέλεσης των συναλλαγών (*Execution stage*) διαρκεί για τον περισσότερο χρόνο της συνολικής διαδικασίας,
η συγκεκριμένη εργασία περιορίστηκε στην επιτάχυνση αυτού του σταδίου και μόνο.
Επομένως, κάθε επιλογή που εξετάζεται αναφέρεται στο συγκεκριμένο στάδιο και τα αποτελέσματα που αναφέρονται στα υπόλοιπα κεφάλαια,
αγνοούν το χρόνο εκτέλεσης των υπόλοιπων σταδίων, κάποια εκ των οποίων (πχ μεταφόρτωσης του blockchain - *Downloading stage*)
θα ήταν ανώφελο να μετρηθούν μιας και εξαρτώνται από συνθήκες δικτύου που ? vary widely ? χρονικά και γεωγραφικά.

Ο σκοπός της εργασίας είναι η βελτίωση της ταχύτητας αυτού του σταδίου με την παράλληλη προανάκτηση προβλεπόμενων εγγραφών από τη βάση δεδομένων.
Το σύστημα περιορίζεται σε κοινό και εμπορικά διαθέσιμο υλισμικό (*hardware*).
Επίσης, για να διασφαλιστεί η ασφάλεια της διαδικασίας εκτέλεσης των contract, λόγω της κρίσιμης φύσης της, οι ενέργειες της προανάκτησης
δεν θα πρέπει να καθορίζουν τα δεδομένα που χρησιμοποιούνται και αποθηκεύονται στο *Wolrd State*.
Έτσι, τυγχών σφάλματα (bugs) ή αδυναμίες (vulnerabilities) σε αυτό το κομμάτι δεν θα threat to compromise την ασφάλεια ολόκληρου του συστήματος,
και η εκτέλεση θα μπορεί σε κάθε περίπτωση να προχωρά κανονικά, πιθανών επιρρεασμένη μόνο ως προς το χρόνο εκτέλεσης.
Σε καμία περίπτωση δεν θα πρέπει το κομμάτι της προανάκτησης να έχει τη δυνατότητα να τροποποιήσει δεδομένα του *World State*.
Αυτό περιορίζει τη δυνατότητα προ-επεξεργασίας δεδομένων που θα μπορούσε να αποφέρει καλύτερες επιδόσεις
αλλά θα έκανε πιο πολύπλοκη τη λογική του κρίσιμου σταδίου της εκτέλεσης που θα δημιουργούσε περισσότερες θέσεις για πιθανά σφάλματα.
Μοναδική εξέραιση στα παραπάνω θα αποτελέση η προανάκτηση των block η οποία όμως γίνεται ντετερμινιστικά και χωρίς αλλαγές από τον αρχικό κώδικα,
παραμόνο η τοποθέτησή της σε ξεχωριστό νήμα (thread).

Τέλος, σε πιθανή κρίσημη αποτυχία και διακοπή της διαδικασίας προανάκτησης, η κύρια εκτέλεση του client θα συνεχίζεται σαν να μην υπήρχε εξ' αρχής.

## Υψηλού επιπέδου περιγραφή

Η εργασία αποτελείται από 3 συνολικά κομμάτια που θα εξεταστούν παρακάτω:
- Iχνογράφηση (Tracing):     Συλλογή στατιστικών και κώδικα των contracts
- Ανάλυση     (Analysis):    Ανάλυση των contracts που συλλέχθηκαν στην ιχνογράφηση και σύνθεση των *predictors*
- Προανάκτηση (Prefetching): Προανάκτηση και υποθετική εκτέλεση των *predictors* που δημιουργήθηκαν στην ανάλυση


\begin{figure}[!htbp]
  \centering
  \includesvg[inkscapelatex=false,width=\textwidth]{../main/Overview.svg}
  \caption{Υψηλού επιπέδου όψη του συστήματος.}
\end{figure}


Κεντρική αρμοδιότητα του σύστηματος είναι προανάκτηση από τη βάση δεδομένων, των λογαριασμών, του κώδικα των contract καθώς και τις διευθύνσεις storage που αυτά χρησιμοποιούν. Η ανάκτηση των λογαρισμών και contracts που αναγράφονται πάνω στα transaction αποτελεί την απλή περίπτωση. Πέραν αυτών, γίνεται ανάκτηση και άλλων λογαριασμών και contracts που μπορεί να χρησιμοποιεί κατά την εκτέλεσή του ένα transaction, όπως φάνηκε και από τα εμφωλευμένα message calls σε προηγούμενο κεφάλαιο (σχήμα 3.1). Για τη δεύτερη αυτή περίπτωση, εκτελούνται υποθετικά οι *predictors*. Κάθε *predictor* αποτελεί σύντομο πρόγραμμα, με κώδικα παράγωγο από του contract από το οποίο προέρχεται. Η διαφορά του με το αρχικό είναι ότι έχουν κρατηθεί μόνο εντολές χρήσιμες για τους σκοπούς της προανάκτησης και έχουν αφαιρεθεί τμήματα που θεωρούνται σπάνια, με βάση τα δεδομένα που συλλέγονται στο *tracing*.

Η εκτέλεση της προανάκτησης γίνεται λίγα block πιο μπροστά από την κύρια εκτέλεση. Αυτή η διαφορά είναι περιορισμένη εκ των προτέρων και η μέγιστη τιμή της αναφέρεται ως *readahead*, η οποία περιγράφεται πιο αναλυτικά στην παράγραφο 5.3.2 . Στην περίπτωση που απεικονίζεται στο σχήμα 4.1, η διαφορά αυτή είναι ίση με 3.

Τα δεδομένα που προανακτώνται *δεν* χρησιμοποιώνται κατά την κύρια εκτέλεση. Ο μόνος τρόπος που επιρρεάζουν την εκτέλεση είναι χρονικά, "ζεσταίνοντας" την cache του συστήματος αρχείων.

Μία πιο αναλυτική απεικόνηση του συστήματος προανάκτησης φαίνεται στο σχήμα 5.9 και περιγράφεται στην ενότητα 5.3.

Τα κομμάτια της ιχνογράφησης και ανάλυσης στις δοκιμές του επόμενου κεφαλαίου εκτελούνται ξεχωριστά, για λόγους απλότητας,
αλλά σε μια πραγματική υλοποίηση αναμένουμε να τρέχουν ταυτόχρονα, παράλληλα με την κύρια εκτέλεση. Ο χρόνος της κύριας εκτέλεσης είναι σημαντικά μεγαλύτερος από το χρόνο που διαρκεί η ανάλυση για τα contract της αντίστοιχης περιόδου.
